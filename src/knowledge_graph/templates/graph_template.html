<div class="card" style="width: 100%">
    <div id="graph-controls" style="margin: 10px; display: flex; justify-content: space-between;">
        <div>
            <button onclick="togglePhysics()" id="physics-toggle" class="btn btn-primary">Disable Physics</button>
            <button onclick="togglePhysicsSettings()" id="physics-settings-toggle" class="btn btn-outline-info">Physics Settings</button>
            <button onclick="stabilizeNetwork()" class="btn btn-secondary">Stabilize</button>
            <button onclick="toggleDarkMode()" id="theme-toggle" class="btn btn-info">Dark Mode</button>
            <button onclick="toggleFilterMenu()" id="filter-toggle" class="btn btn-outline-info">Show Filters</button>
        </div>
        <div>
            <span style="margin-right: 15px;"><strong>Communities:</strong></span>
            <span style="background-color: #e41a1c; width: 20px; height: 20px; display: inline-block; margin-right: 5px;"></span>
            <span style="background-color: #377eb8; width: 20px; height: 20px; display: inline-block; margin-right: 5px;"></span>
            <span style="background-color: #4daf4a; width: 20px; height: 20px; display: inline-block; margin-right: 5px;"></span>
            <span style="background-color: #984ea3; width: 20px; height: 20px; display: inline-block; margin-right: 5px;"></span>
            <span style="background-color: #ff7f00; width: 20px; height: 20px; display: inline-block; margin-right: 5px;"></span>
        </div>
    </div>
    
    <div id="physics-settings-container" style="display: none; margin: 10px; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
        <h5>Physics Settings</h5>
        <div style="display: flex; flex-wrap: wrap; gap: 15px;">
            <div style="min-width: 200px;">
                <label for="physics-solver">Solver</label>
                <select id="physics-solver" class="form-select" onchange="changeSolver()">
                    <option value="forceAtlas2Based">Force Atlas 2</option>
                    <option value="barnesHut">Barnes-Hut</option>
                    <option value="repulsion">Repulsion</option>
                </select>
            </div>
            
            <!-- Force Atlas 2 settings -->
            <div id="forceAtlas2Based-settings" class="solver-settings">
                <div class="setting-group">
                    <label for="fa2-gravConstant">Gravitational Constant</label>
                    <input type="range" id="fa2-gravConstant" min="-200" max="0" value="-50" class="form-range" oninput="updatePhysicsValue(this)">
                    <small class="value-display">-50</small>
                </div>
                <div class="setting-group">
                    <label for="fa2-centralGravity">Central Gravity</label>
                    <input type="range" id="fa2-centralGravity" min="0" max="1" step="0.01" value="0.01" class="form-range" oninput="updatePhysicsValue(this)">
                    <small class="value-display">0.01</small>
                </div>
                <div class="setting-group">
                    <label for="fa2-springLength">Spring Length</label>
                    <input type="range" id="fa2-springLength" min="10" max="500" value="100" class="form-range" oninput="updatePhysicsValue(this)">
                    <small class="value-display">100</small>
                </div>
                <div class="setting-group">
                    <label for="fa2-springConstant">Spring Constant</label>
                    <input type="range" id="fa2-springConstant" min="0" max="1" step="0.01" value="0.08" class="form-range" oninput="updatePhysicsValue(this)">
                    <small class="value-display">0.08</small>
                </div>
            </div>
            
            <!-- Barnes-Hut settings -->
            <div id="barnesHut-settings" class="solver-settings" style="display: none;">
                <div class="setting-group">
                    <label for="bh-gravConstant">Gravitational Constant</label>
                    <input type="range" id="bh-gravConstant" min="-30000" max="-1000" value="-8000" class="form-range" oninput="updatePhysicsValue(this)">
                    <small class="value-display">-8000</small>
                </div>
                <div class="setting-group">
                    <label for="bh-centralGravity">Central Gravity</label>
                    <input type="range" id="bh-centralGravity" min="0" max="1" step="0.01" value="0.3" class="form-range" oninput="updatePhysicsValue(this)">
                    <small class="value-display">0.3</small>
                </div>
                <div class="setting-group">
                    <label for="bh-springLength">Spring Length</label>
                    <input type="range" id="bh-springLength" min="10" max="500" value="250" class="form-range" oninput="updatePhysicsValue(this)">
                    <small class="value-display">250</small>
                </div>
                <div class="setting-group">
                    <label for="bh-springConstant">Spring Constant</label>
                    <input type="range" id="bh-springConstant" min="0" max="1" step="0.01" value="0.04" class="form-range" oninput="updatePhysicsValue(this)">
                    <small class="value-display">0.04</small>
                </div>
                <div class="setting-group">
                    <label for="bh-damping">Damping</label>
                    <input type="range" id="bh-damping" min="0" max="1" step="0.01" value="0.09" class="form-range" oninput="updatePhysicsValue(this)">
                    <small class="value-display">0.09</small>
                </div>
            </div>
            
            <!-- Repulsion settings -->
            <div id="repulsion-settings" class="solver-settings" style="display: none;">
                <div class="setting-group">
                    <label for="rep-nodeDistance">Node Distance</label>
                    <input type="range" id="rep-nodeDistance" min="10" max="300" value="100" class="form-range" oninput="updatePhysicsValue(this)">
                    <small class="value-display">100</small>
                </div>
                <div class="setting-group">
                    <label for="rep-centralGravity">Central Gravity</label>
                    <input type="range" id="rep-centralGravity" min="0" max="1" step="0.01" value="0.2" class="form-range" oninput="updatePhysicsValue(this)">
                    <small class="value-display">0.2</small>
                </div>
                <div class="setting-group">
                    <label for="rep-springLength">Spring Length</label>
                    <input type="range" id="rep-springLength" min="10" max="500" value="200" class="form-range" oninput="updatePhysicsValue(this)">
                    <small class="value-display">200</small>
                </div>
                <div class="setting-group">
                    <label for="rep-springStrength">Spring Strength</label>
                    <input type="range" id="rep-springStrength" min="0" max="1" step="0.01" value="0.05" class="form-range" oninput="updatePhysicsValue(this)">
                    <small class="value-display">0.05</small>
                </div>
                <div class="setting-group">
                    <label for="rep-damping">Damping</label>
                    <input type="range" id="rep-damping" min="0" max="1" step="0.01" value="0.09" class="form-range" oninput="updatePhysicsValue(this)">
                    <small class="value-display">0.09</small>
                </div>
            </div>
            
            <div style="margin-top: 15px;">
                <button onclick="applyPhysicsSettings()" class="btn btn-success">Apply Settings</button>
                <button onclick="resetPhysicsSettings()" class="btn btn-outline-secondary">Reset</button>
            </div>
        </div>
    </div>
    
    <div id="filter-menu-container" style="display: none; margin: 10px;">
        <div class="filter-row" style="display: flex; gap: 10px; margin-bottom: 10px;">
            <select id="node-select" class="form-select" style="flex: 1;">
                <option value="">Select a Node by ID</option>
            </select>
            <button onclick="resetSelection()" class="btn btn-primary">Reset Selection</button>
        </div>
        <div class="filter-row" style="display: flex; gap: 10px;">
            <select id="item-select" class="form-select" style="flex: 1;">
                <option value="">Select a network item</option>
                <option value="node">Nodes</option>
                <option value="edge">Edges</option>
            </select>
            <select id="property-select" class="form-select" style="flex: 1;">
                <option value="">Select a property</option>
            </select>
            <select id="value-select" class="form-select" style="flex: 1;">
                <option value="">Select value(s)</option>
            </select>
            <button onclick="filterSelection()" class="btn btn-primary">Filter</button>
            <button onclick="resetSelection()" class="btn btn-primary">Reset Selection</button>
        </div>
    </div>
    <div id="mynetwork" class="card-body"></div>
</div>

<style id="theme-styles">
    /* Light mode (default) */
    body.light-mode {
        background-color: white;
        color: black;
    }
    
    /* Dark mode */
    body.dark-mode {
        background-color: #121212;
        color: #e0e0e0;
    }
    
    body.dark-mode .card {
        background-color: #1e1e1e;
        border-color: #333;
    }
    
    body.dark-mode .btn {
        border-color: #444;
    }
    
    body.dark-mode #mynetwork {
        border-color: #333;
        background-color: #000000;
    }
    
    body.dark-mode .form-select {
        background-color: #333;
        color: #e0e0e0;
        border-color: #555;
    }
    
    /* Physics settings styles */
    #physics-settings-container {
        background-color: #f8f9fa;
    }
    
    body.dark-mode #physics-settings-container {
        background-color: #2d2d2d;
        border-color: #444;
    }
    
    .setting-group {
        margin-bottom: 12px;
        min-width: 200px;
    }
    
    .setting-group label {
        display: block;
        margin-bottom: 3px;
        font-size: 14px;
    }
    
    .setting-group .value-display {
        display: inline-block;
        min-width: 40px;
        text-align: right;
    }
    
    .solver-settings {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }
    
    /* Node label colors - strong selectors to override vis.js styles */
    .vis-network .vis-node {
        font-family: Tahoma, sans-serif;
    }
    
    /* Strongest selectors for node text color */
    .vis-network text,
    .vis-network text.vis-text,
    .vis-network .vis-node text,
    .vis-network text[class*="vis-"],
    .vis-network .vis-label text {
        fill: #000000 !important;
        stroke: none !important;
        color: #000000 !important;
    }
    
    body.dark-mode .vis-network text,
    body.dark-mode .vis-network text.vis-text,
    body.dark-mode .vis-network .vis-node text,
    body.dark-mode .vis-network text[class*="vis-"],
    body.dark-mode .vis-network .vis-label text {
        fill: #ffffff !important;
        stroke: none !important;
        color: #ffffff !important;
    }
</style>

<script>
// Helper function to ensure node text colors are correct
function updateNodeTextColors(color) {
    if (!network || !network.body || !network.body.data || !network.body.data.nodes) return;
    
    try {
        // Update through vis.js API
        const nodeIds = network.body.data.nodes.getIds();
        const updates = nodeIds.map(nodeId => ({
            id: nodeId,
            font: { 
                color: color,
                strokeWidth: 0 
            }
        }));
        network.body.data.nodes.update(updates);
        
        // Direct manipulation of SVG text elements as fallback
        setTimeout(() => {
            try {
                const textElements = document.querySelectorAll('.vis-network text');
                textElements.forEach(el => {
                    el.style.fill = color;
                    el.setAttribute('fill', color);
                });
            } catch (e) {
                console.error('Error directly manipulating SVG:', e);
            }
        }, 100);
    } catch (e) {
        console.error('Error updating node colors:', e);
    }
}

function togglePhysics() {
    const toggleBtn = document.getElementById('physics-toggle');
    
    if (network.physics.options.enabled) {
        network.physics.stopSimulation();
        network.setOptions({physics: {enabled: false}});
        toggleBtn.textContent = 'Enable Physics';
        toggleBtn.classList.remove('btn-primary');
        toggleBtn.classList.add('btn-outline-primary');
    } else {
        network.setOptions({physics: {enabled: true}});
        network.startSimulation();
        toggleBtn.textContent = 'Disable Physics';
        toggleBtn.classList.remove('btn-outline-primary');
        toggleBtn.classList.add('btn-primary');
    }
}

function togglePhysicsSettings() {
    const container = document.getElementById('physics-settings-container');
    const button = document.getElementById('physics-settings-toggle');
    
    if (container.style.display === 'none') {
        container.style.display = 'block';
        button.textContent = 'Hide Physics Settings';
        button.classList.remove('btn-outline-info');
        button.classList.add('btn-info');
    } else {
        container.style.display = 'none';
        button.textContent = 'Physics Settings';
        button.classList.remove('btn-info');
        button.classList.add('btn-outline-info');
    }
}

function changeSolver() {
    const selectedSolver = document.getElementById('physics-solver').value;
    
    // Hide all solver setting sections
    document.querySelectorAll('.solver-settings').forEach(el => {
        el.style.display = 'none';
    });
    
    // Show the selected solver settings
    document.getElementById(`${selectedSolver}-settings`).style.display = 'flex';
}

function updatePhysicsValue(input) {
    // Update the display value next to the slider
    const valueDisplay = input.nextElementSibling;
    valueDisplay.textContent = input.value;
}

function applyPhysicsSettings() {
    const solver = document.getElementById('physics-solver').value;
    let physicsOptions = { solver: solver };
    
    // Get the settings for the selected solver
    if (solver === 'forceAtlas2Based') {
        physicsOptions.forceAtlas2Based = {
            gravitationalConstant: parseFloat(document.getElementById('fa2-gravConstant').value),
            centralGravity: parseFloat(document.getElementById('fa2-centralGravity').value),
            springLength: parseFloat(document.getElementById('fa2-springLength').value),
            springConstant: parseFloat(document.getElementById('fa2-springConstant').value)
        };
    } else if (solver === 'barnesHut') {
        physicsOptions.barnesHut = {
            gravitationalConstant: parseFloat(document.getElementById('bh-gravConstant').value),
            centralGravity: parseFloat(document.getElementById('bh-centralGravity').value),
            springLength: parseFloat(document.getElementById('bh-springLength').value),
            springConstant: parseFloat(document.getElementById('bh-springConstant').value),
            damping: parseFloat(document.getElementById('bh-damping').value)
        };
    } else if (solver === 'repulsion') {
        physicsOptions.repulsion = {
            nodeDistance: parseFloat(document.getElementById('rep-nodeDistance').value),
            centralGravity: parseFloat(document.getElementById('rep-centralGravity').value),
            springLength: parseFloat(document.getElementById('rep-springLength').value),
            springConstant: parseFloat(document.getElementById('rep-springStrength').value),
            damping: parseFloat(document.getElementById('rep-damping').value)
        };
    }
    
    // Apply the settings
    network.setOptions({ physics: physicsOptions });
    
    // Restart the simulation
    network.startSimulation();
    
    // Update the physics toggle button
    const toggleBtn = document.getElementById('physics-toggle');
    toggleBtn.textContent = 'Disable Physics';
    toggleBtn.classList.remove('btn-outline-primary');
    toggleBtn.classList.add('btn-primary');
    
    console.log('Applied physics settings:', physicsOptions);
}

function resetPhysicsSettings() {
    // Reset Force Atlas 2 settings
    document.getElementById('fa2-gravConstant').value = -50;
    document.getElementById('fa2-centralGravity').value = 0.01;
    document.getElementById('fa2-springLength').value = 100;
    document.getElementById('fa2-springConstant').value = 0.08;
    
    // Reset Barnes-Hut settings
    document.getElementById('bh-gravConstant').value = -8000;
    document.getElementById('bh-centralGravity').value = 0.3;
    document.getElementById('bh-springLength').value = 250;
    document.getElementById('bh-springConstant').value = 0.04;
    document.getElementById('bh-damping').value = 0.09;
    
    // Reset Repulsion settings
    document.getElementById('rep-nodeDistance').value = 100;
    document.getElementById('rep-centralGravity').value = 0.2;
    document.getElementById('rep-springLength').value = 200;
    document.getElementById('rep-springStrength').value = 0.05;
    document.getElementById('rep-damping').value = 0.09;
    
    // Update all displayed values
    document.querySelectorAll('.form-range').forEach(input => {
        const valueDisplay = input.nextElementSibling;
        valueDisplay.textContent = input.value;
    });
    
    // Reset to Force Atlas 2
    document.getElementById('physics-solver').value = 'forceAtlas2Based';
    changeSolver();
    
    // Apply the default settings
    applyPhysicsSettings();
}

function stabilizeNetwork() {
    network.stabilize(100);
}

function toggleDarkMode() {
    const body = document.body;
    const toggleBtn = document.getElementById('theme-toggle');
    
    if (body.classList.contains('dark-mode')) {
        // Switch to light mode
        body.classList.remove('dark-mode');
        body.classList.add('light-mode');
        toggleBtn.textContent = 'Dark Mode';
        
        // Update network with light mode settings
        network.setOptions({
            background: {
                color: 'white'
            },
            nodes: {
                font: {
                    color: '#000000',
                    strokeWidth: 0
                }
            },
            edges: {
                font: {
                    color: '#000000',
                    strokeWidth: 4  // Default border for light mode
                }
            }
        });
        
        // Force correct node text color
        updateNodeTextColors('#000000');
    } else {
        // Switch to dark mode
        body.classList.remove('light-mode');
        body.classList.add('dark-mode');
        toggleBtn.textContent = 'Light Mode';
        
        // Update network with dark mode settings
        network.setOptions({
            background: {
                color: '#1e1e1e'
            },
            nodes: {
                font: {
                    color: '#ffffff',
                    strokeWidth: 0
                }
            },
            edges: {
                font: {
                    color: '#ffdd00',  // Yellow color for edge text
                    strokeWidth: 0     // Remove text border/stroke in dark mode
                }
            }
        });
        
        // Force correct node text color
        updateNodeTextColors('#ffffff');
    }
}

function toggleFilterMenu() {
    const container = document.getElementById('filter-menu-container');
    const button = document.getElementById('filter-toggle');
    
    if (container.style.display === 'none') {
        container.style.display = 'block';
        button.textContent = 'Hide Filters';
        button.classList.remove('btn-outline-info');
        button.classList.add('btn-info');
        populateFilterOptions();
    } else {
        container.style.display = 'none';
        button.textContent = 'Show Filters';
        button.classList.remove('btn-info');
        button.classList.add('btn-outline-info');
    }
}

function populateFilterOptions() {
    // Get all node IDs for the node selector
    const nodeSelect = document.getElementById('node-select');
    // Clear existing options except the first one
    while (nodeSelect.options.length > 1) {
        nodeSelect.remove(1);
    }
    
    // Add all nodes to the select
    const nodeIds = network.body.data.nodes.getIds();
    nodeIds.forEach(nodeId => {
        const option = document.createElement('option');
        option.value = nodeId;
        option.text = nodeId;
        nodeSelect.appendChild(option);
    });
}

function resetSelection() {
    network.unselectAll();
}

function filterSelection() {
    const itemType = document.getElementById('item-select').value;
    const property = document.getElementById('property-select').value;
    const value = document.getElementById('value-select').value;
    
    if (itemType && property && value) {
        // This is a simplified version - you would need to implement actual filtering logic
        alert('Filtering not fully implemented in this simplified version');
    } else {
        alert('Please select all filter criteria');
    }
}

// Set initial theme class
document.body.classList.add('light-mode');

// Rewritten approach for node text colors
(function() {
    // Function to handle network initialization
    function initializeNetwork() {
        if (!window.network) return false;
        
        console.log("Setting initial network options");
        
        // Force node text color settings
        network.setOptions({
            nodes: {
                font: {
                    color: '#000000',
                    face: 'Tahoma',
                    strokeWidth: 0
                }
            }
        });
        
        // Set physics toggle button state based on network physics state
        const physicsToggleBtn = document.getElementById('physics-toggle');
        if (physicsToggleBtn) {
            if (network.physics.options.enabled) {
                physicsToggleBtn.textContent = 'Disable Physics';
                physicsToggleBtn.classList.remove('btn-outline-primary');
                physicsToggleBtn.classList.add('btn-primary');
            } else {
                physicsToggleBtn.textContent = 'Enable Physics';
                physicsToggleBtn.classList.remove('btn-primary');
                physicsToggleBtn.classList.add('btn-outline-primary');
            }
        }
        
        // Apply direct SVG manipulation
        const textElements = document.querySelectorAll('.vis-network text');
        textElements.forEach(el => {
            el.style.fill = '#000000';
            el.setAttribute('fill', '#000000');
            el.style.stroke = 'none';
            el.setAttribute('stroke', 'none');
        });
        
        return true;
    }
    
    // Add a style tag to force node colors
    const style = document.createElement('style');
    style.textContent = `
        .vis-network text { fill: #000000 !important; color: #000000 !important; }
        body.dark-mode .vis-network text { fill: #ffffff !important; color: #ffffff !important; }
    `;
    document.head.appendChild(style);
    
    // Try to initialize immediately
    if (initializeNetwork()) {
        console.log("Network initialized immediately");
    }
    
    // DOMContentLoaded approach
    document.addEventListener('DOMContentLoaded', function() {
        // Check for network repeatedly
        const networkCheck = setInterval(() => {
            if (initializeNetwork()) {
                console.log("Network initialized via interval");
                clearInterval(networkCheck);
            }
        }, 50);
        
        // Backup timeout approaches
        for (let i = 1; i <= 20; i++) {
            setTimeout(() => {
                if (window.network) {
                    console.log(`Applying color fix at ${i*100}ms`);
                    initializeNetwork();
                    updateNodeTextColors('#000000');
                }
            }, i * 100);
        }
    });
    
    // Add mutation observer to catch when network is added to DOM
    const observer = new MutationObserver((mutations) => {
        for (const mutation of mutations) {
            if (mutation.addedNodes.length) {
                if (window.network) {
                    console.log("Network detected via mutation observer");
                    initializeNetwork();
                    updateNodeTextColors('#000000');
                    observer.disconnect();
                    break;
                }
            }
        }
    });
    
    // Start observing
    observer.observe(document.body, { childList: true, subtree: true });
})();

// Original network stabilization listener (keep this)
network.once("stabilizationIterationsDone", function() {
    // Auto-stabilize after initial load
    setTimeout(function() {
        // Don't stop simulation since physics is now on by default
        
        // Set physics toggle button state
        const physicsToggleBtn = document.getElementById('physics-toggle');
        if (physicsToggleBtn) {
            physicsToggleBtn.textContent = 'Disable Physics';
            physicsToggleBtn.classList.remove('btn-outline-primary');
            physicsToggleBtn.classList.add('btn-primary');
        }
    }, 1000);
    
    // Ensure node and edge text colors are set correctly for initial light mode
    network.setOptions({
        nodes: {
            font: {
                color: '#000000',
                face: 'Tahoma',
                strokeWidth: 0
            }
        },
        edges: {
            font: {
                color: '#000000',
                strokeWidth: 4  // Default border for light mode
            }
        }
    });
    
    // Fix any nodes that might have incorrect font color
    updateNodeTextColors('#000000');
    
    console.log("Network stabilization complete");
});
</script> 